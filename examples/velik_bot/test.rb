require "maxitest/autorun"

require_relative "flace"
Flace "nakischema"
Flace "unicode/blocks"

require_relative "common"
Common.init_repdb "test"

describe "unit1" do

  it "smart_match" do
clips = <<~HEREDOC.split("\n")
  #zaebis —á–µ—Ç–∫–æ
  #–∂–∏–≤–∏–∂–∏–≤–∏–∂–∏–≤–∏
  (
  ))))
  +—Ö–æ—Ä–æ—à–µ–π —Ä–µ–≥–∏
  - –µ—â–µ –æ–¥–∏–Ω –≥—Ä–∏–±–Ω–∏–∫
  -1
  -1 –≥—Ä–∏–±–Ω–∏–∫!
  -2
  1
  1 —Ä–µ–π–¥
  1111
  2
  2 –º–∏–Ω—É—Å
  222
  3 –±–æ—Å—Å–∞
  300 IQ play
  333
  47 —É—Ä–æ–≤–Ω–µ–π —Å—Ç—Ä–∞–¥–∞–Ω–∏–π.
  ???
  akiiz tiaes and a dream
  Apatiya 4x4
  awww hell
  clown
  DROPS ON ‚úÖ Lets Go, Eüí≤cape From ETO TI ?üêÄ
  FBI open door
  FBI! Open up!
  Follow
  Go back to lobby rat)
  hahahahahahahha
  lya kakaya
  otkisla kiska
  pyk pyk srenlk
  SIDIM PERDIM
  UWU
  Uwu twix
  ZASADA
  –ê –∫–∞–∫ —É–±–∏—Ç—å?
  –ê –∫—Ç–æ —ç—Ç–æ —Ç–∞–º –ø–æ–¥ –∫–∞–º—É—à–∫–æ–º —Å–∏–¥–∏—Ç!)
  –ê —Ç—ã –∫—Ç–æ?
  –ê —É–º–µ—Ä–µ—Ç—å?
  –∞ —É–º–µ—Ä–µ—Ç—å?!
  –ê —è —Ç—É—Ç)
  –ê–∫—Ç–µ—Ä –±–µ–∑ –æ—Å–∫–∞—Ä–∞
  –ê–ª–ª–æ —ç—Ç–æ –ñ–æ—Å–∫–∞?
  –ê–ª–ª–æ, –ë—É—è–Ω–æ–≤?
  –ê–ª–ª–æ, –ù–∏–∫–∏—Ç–∞?)
  –∞—Ö—Ö–∞—Ö–∞
  –±–µ–≥—É –±–µ–≥—É!!!
  –ë–æ–π –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ!
  –ë–æ–ª—å—à–∞—è –±—É—Ç—ã–ª–∫–∞
  –ë–æ—Ç—ã —Å–æ–≤—Å–µ–º –∫—Ä–µ–π–∑–∏!
  –ë—É—Ä–Ω—ã–µ —Ä—É–∫–æ–ø–ª–µ—Å–∫–∞–Ω–∏—è
  –ë—É—Ö–ª–æ—Å—Ç—Ä–∏–º –Æ–•–£–£–£
  –ë—ç—Ç–º–∞–Ω
  –í –ª–æ–±–∏)
  –≤ –Ω–æ—Ä–∫—É
  –í–∞–ª–µ—Ä–æ—Å –ú–ê–®–ò–ù–ê 2
  –í–∏–¥–µ–æ–æ–ø–µ—Ä–∞—Ç–æ—Ä
  –í–∏—Ç–∞–ª–∏–∫ -  –º—É–∂—Å–∫–æ–µ —Ä—É—Å—Å–∫–æ–µ –ª–∏—á–Ω–æ–µ –∏–º—è –¥—Ä–µ–≤–Ω–µ—Ä–∏–º—Å–∫–æ–≥–æ –ø—Ä–æ–∏—Å—Ö–æ–∂–¥–µ–Ω–∏—è.
  –í–Ω–µ–∑–∞–ø–Ω–æ—Å—Ç—å - —Å–µ—Å—Ç—Ä–∞ —Ç–∞–ª–∞–Ω—Ç–∞)
  –í–æ–≤—á–µ–∫ –ù–∞ —Ç—É—Ä–Ω–∏—Ä—á–∏–∫–µ)))
  –í–æ–ª—à–µ–±–Ω–∏–∫–∏ –≤–Ω–µ –•–æ–≥–≤–∞—Ä—Å—Ç–∞
  –í–æ–æ–æ–æ–æ–Ω –æ–Ω
  –í–æ–ø—Ä–æ—Å–∏–∫–∏
  –í–æ—Å—Å–µ–¥–∞—Ç–µ–ª—å –∫—É—Å—Ç–∞—Ä–Ω—ã–π
  –≤–æ—Ç –∑–¥–µ—Å—å –º–µ–Ω—è –∏ —É–±–∏–ª–∏
  –í–æ—Ç –Ω–∞—Å—Ç–æ—è—à–∏–π –®—Ç—É—Ä–º–æ–≤–∏–∫!
  –≤—Å–µ –í—Ä–∞–∫–∏
  –í—Å–µ –¥–æ—Ä–æ–≥–∏ –≤–µ–¥—É—Ç –≤ –¢–∞—Ä–∫–æ–≤. 48 —É—Ä–æ–≤–Ω–µ–π —Å—Ç—Ä–∞–¥–∞–Ω–∏–π.
  –í—Å–µ–π —Å–≤–æ–µ–π –¥–æ–±—Ä–æ—Ç–æ–π –ø—Ä–æ—à–ª–∞—Å—å –ø–æ –ß–í–ö!
  –≤—Å—Ç—Ä–µ—á–∞ —Å –ª–µ–≥–µ–Ω–¥–æ–π
  –≤—Å—Ç—Ä–µ—á–∞ —Å –ª–µ–≥–µ–Ω–¥–æ–π 2
  –≤—Å—Ç—Ä–µ—á–∞ —Å –ª–µ–≥–µ–Ω–¥–æ–π 3
  –≤—ã–≤–∞–ª–∏–≤–∞–µ–º—Å—è —Å –æ–∫–æ–Ω
  –ì—É–¥ –≥—Ä–µ–Ω–∞ –æ–¥–Ω–∞–∫–æ!
  –î–∞ –±–ª—è—Ç—å)))
  –¥–∞ –±–ª—è—è—è—è—è—è—è—è—Ç—å –∞–Ω–∫–∞–ª)))
  –î–∞ –≤—Å–µ –Ω–æ—Ä–º–∞–ª—å–Ω–æ! –≠—Ç–æ –¢–∞—Ä–∫–æ–≤)))
  –¥–∞–ª–∏ –∫–ª—é—á –Ω–æ –Ω–µ –¥–∞–ª–∏ –æ—Ä—É–∂–∏–µ
  –î–∞–Ω–∏–ª–∞ –∏ –ö–æ. –û–Ω–ª–∞–π–Ω ,–±–µ–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏...
  –î–≤–æ–∏—Ö –ø–∞—Ä–Ω–µ–π –æ–±–∏–¥–µ–ª–∞)
  –î–∏–º–∞ —Ç–∞—â–∏ –ø–∞—Ç—Ä–æ–Ω—ã
  –¥–æ –ø–µ—Ä–≤–æ–π –∫—Ä–æ–≤–∏ –¥–∞–≤–∞–π
  –î–æ–±—Ä–æ–π –Ω–æ—á–∏, –≤—ã –≤–µ—Ä–∏—Ç–µ –≤ —Ö—Ä–∏—Å—Ç–∞ —Å–ø–∞—Å–∏—Ç–µ–ª—è?
  –¥–æ–Ω—Ç —à—É—Ç
  –î–æ–ø—Ä—ã–≥–∞–ª—Å—è))
  –î—Ä–æ–ø –≤–∏–ø–æ–Ω!!!!
  –¥—É —é –±—É–º-–±—É–º
  –î—ã—Ä–∞ –≤ —à–∞–ø–∫–µ
  –ï—Å—Ç—å 1
  –ï—â–µ –æ–¥–∏–Ω
  –ï—â—ë –æ–¥–∏–Ω –Ω–µ –ø–æ–Ω–∏–º–∞—é—â–∏–π –∫–∞–∫ —Ç–∞–∫ —Ç–æ))
  –ñ–∏–≤–µ–º)
  –∑–∞–≤—Ç—ã–∫–∞–ª
  –∑–∞–¥—ã–º–∏–ª
  –ó–∞—Ä—É–±–∏–ª–∏
  –ó–∞—Ç–≤–æ—Ä–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –∫–∞–∫ —É –º16
  –ó–∞—Ç—É–ø–∏–ª–∏ –≥—É–Ω–Ω—ã
  –ó–∞—è–≤–∫–∞ –Ω–∞ por1hub
  –∑–Ω–∞—á–∏—Ç –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –¥–≤–∞ –∑–∞–∂–∏–º–∞—Ç–æ—Ä–∞...
  –∏ –ø—Ä—ã–≥–∞–µ—Ç —Ö–∞—Ö–∞—Ö
  –∏—Ç—å, –∏—Ç—å! –∏—Ç—Å—å!
  –∏—Ö–∏—Ö
  –ö–∞–π—Ñ–æ–≤—ã–π —Ç—É—Ä–∏–∫
  –∫–∞–∫ –æ—Ç–ø–∏—Å–∞—Ç—å—Å—è
  –ö–∞–∫ —Ç–æ —Ç–∞–∫
  –ö–∞–∫–∞—è –∂–∞–ª–æ—Å—Ç—å —Ä–µ–±—è—è—è—è—Ç–∞
  –∫–∞–∫–∞—è –∂–µ —è –≥–ª—É–ø–µ–Ω—å–∫–∞—è)
  –∫–∞–ø–ø–∞
  –ö–∞–ø–ø–∞? –°—é–¥–∞
  –ö–∏–Ω—É–ª–∏ –Ω–∞ –±–∞–ª–ª—ã!
  –∫–ª–∏–Ω, –¥–∏–∫–∏–π + –ª—É—Ç
  –∫–ª—é—á–∏ –ø–æ—Ç–µ—Ä—è–ª
  –ö–æ–±–∏
  –ö–æ–≥–¥–∞ –¥–∞–≤–Ω–æ –Ω–µ –≤–∏–¥–µ–ª –ª–µ–¥—ã–∫—Å—ã...
  –ö–æ–≥–¥–∞ –ß–í–ö —Ö–æ—á–µ—Ç –∂–∏—Ç—å –±–æ–ª—å—à–µ —á–µ–º —Å—Ç—Ä–∏–º–µ—Ä)
  –ö–æ–ª–¥—É–Ω—Å—Ç–≤–æ!
  –ö–æ–Ω–∫—É—Ä—Å –Ω–∞ –ª—É—á—à–µ–≥–æ –∞–∫—Ç–µ—Ä–∞
  –ö–æ–Ω—Ç–µ–Ω—Ç –¥–æ—Å—Ç–æ–π–Ω—ã–π —Å—Ç—Ä–∏–º–∞)
  –ö–æ—à–µ—á–∫–∞ –ø–µ—Ä–µ–ø–∏–ª–∞ –í–∞–ª–µ—Ä—å—è–Ω–∫–∏!
  –ö—Ä–∞—Å–∏–≤–æ —É–º–µ—Ä–µ—Ç—å —Ç–æ–∂–µ –Ω–∞–¥–æ —É–º–µ—Ç—å)
  –∫—Ä–∞—Å–Ω–µ—é—â–∏–π –∫–∞–ª–ª–∏–º–∞—Ç–æ—Ä
  –ö—Ä—ã—Å–∏ —É —Ä—É–±–∏–ª—å–Ω–∏–∫–∞!
  –∫—Ç–æ –±—ã—Å—Ç—Ä–µ–µ –∑–∞–ª—É—Ç–∞–µ—Ç 110)
  –ö—Ç–æ –∫—É–ø–∏–ª?!
  –ª–µ–∂–∏—Ç —Å–º–æ—Ç—Ä–∏—Ç
  –õ–µ—Ä–∞ 18+
  –õ–µ—Ä–∞ –∏ –î–≤–∞ –ê–∫—Ç–µ—Ä–∞!
  –õ–µ—Ä–∞ –∏–≥—Ä–∞–µ—Ç –≤ —Å–∞–ª–æ—á–∫–∏!
  –õ–µ—Ä–∞ –º—Å—Ç–∏—Ç!
  –õ–µ—Ä–∞ –ø—Ä–æ—Ç–∏–≤ –¥–≤—É—Ö —Ñ—É–ª–æ—á–µ–∫, –∫–æ—Ç–æ—Ä—ã–µ –µ–µ –±–æ—è—Ç—å—Å—è)
  –õ–µ—Ä–∞ –ø—Ä–æ—Ç–∏–≤ —Å–æ–≤–µ—Ç—Å–∫–æ–≥–æ –≤–æ–π–Ω–∞!
  –õ–µ—Ä–∞ —Ç–∏–ø–∞ –ø—É—à–∏—Ç –¥–≤–µ—Ä—å!
  –õ–µ—Ä–æ–Ω –≤ —Ç–æ–ø –ø–æ–∑–∏—Ü–∏–∏!
  –õ–µ—Ä–æ–Ω –≤—Å–µ—Ö —É–±–∏–≤–æ–Ω)
  –õ–µ—Ö —Ç—ã ?
  –õ—É—à—á–∞—è –∏–≥—Ä–∞ —ç—Ç–æ –¢–∞—Ä–∫–æ–≤!
  –º–∞–∑–∞ –¥–∞–ª
  –º–∞—Ä—à—Ä—É—Ç–∫–∞
  –º–∞—Å—Ç–µ—Ä –∫—Ä–∞–¥—É–Ω))))
  –ú–∞—É–≥–ª–∏
  –º–∞—à–∏–Ω–∞
  –ú–ê–®–ò–ù–ê –õ–ï–†–ê
  –ú–∏–Ω—É—Å –¥–≤–∞, —Ç–∞–∫ –º–∏–Ω—É—Å –¥–≤–∞!
  –ú–∏–Ω—É—Å —Ü–µ–Ω–Ω–æ–π –¥–≤—É—Ö —Ö–æ—Ä–æ—à–∏—Ö –ø–∞—Ä–Ω–µ–π!
  –ú–∏–Ω—É—Å!
  –ú–∏—Ä,—Ç—Ä—É–¥,–º–∞–π,–¢–∞—Ä–∫–æ–≤.
  –ú–∫–∏!
  –ú–ú–ú –î–ï–õ–ò–®–ï–° <3
  –º–Ω–µ –ø
  –ú–Ω–µ —Ç–∞–∫ –±—ã–≤—à–∞—è –≥–æ–≤–æ—Ä–∏–ª–∞
  –ú–æ–ª–µ–∫—É–ª–∞
  –ú—Å—Ç—è –∑–∞ –í–∞–ª–µ—Ä—É!
  –ú—ã –ø—Ä–æ—Å—Ç–æ –º–∏–º–æ –ø—Ä–æ–π–¥–µ–º
  –ú–´–®–ö–ê –°–†–ê–ë–û–¢–ê–õ–ê –ù–ê –°–õ–ê–í–£
  –ú—è—É —Ç–≤–∏–∫—Å–∞)
  –ù–ê–ù–ò!?
  –ù–∞–ø–∞–ª–∏ –Ω–∞ —Å–∞—à—É–ª—å–∫—É
  –Ω–∞—ç–ª–µ–∫—Ç—Ä–∏–∑–æ–≤–∞–Ω–∞ –∂–æ–ø—É —Å—Ç—É–ª–æ–º
  –Ω–µ –≤–µ—Ä–∏—Ç =)
  –Ω–µ —É–±–∏–≤–∞—é—Ç
  –ù–µ—Ñ–∏–≥ –∫—É—à–∞—Ç—å –æ–±–µ–∑–±–æ–ª –ø—Ä–∏ –õ–µ—Ä–µ)
  –ù–∏–Ω–¥–∑—è
  –ù–∏—à—Ç—è–∫ –ø–∞—Ü–∞–Ω—ã , –∑–∞–≤—Ç—Ä–∞ –Ω–∞ —Ä–∞–±–æ—Ç—É)))
  –ù–∏—à—Ç—è–∫ –ø–∞—Ü–∞–Ω—ã, –∑–∞–≤—Ç—Ä–∞ –≤—ã—Ö–æ–¥–Ω—ã–µ)))
  –ù—É —Ç—ã –¥—É—Ä–∞–∫ –∏–ª–∏ —á–µ?
  –ù—É —á—Ç–æ? –ê–≤–∞–Ω–ø–æ—Å—Ç,–ø–∞—Ü–∞–Ω—ã. 44 —É—Ä–æ–≤–Ω—è —Å—Ç—Ä–∞–¥–∞–Ω–∏–π)
  –û —Ö–µ—Ä–∞—Å–µ, –ø–∞—Ü–∞–Ω –≥–æ—Ç–æ–≤.
  –æ–±–µ—â–∞–Ω–∏–µ —Å–≤–æ–¥–∏—Ç—å –Ω–∞ –ª–∞–±—É –æ—Ç Etenaris
  –æ–±–∏–¥–µ–ª–∞—Å—å –ª–µ—Ä–∫–∞(
  –û–¥–Ω–∏–º –∑–∞–∂–∏–º–æ–º -2
  –æ–∫–Ω–æ 3 —ç—Ç–∞–∂, —Å–ø—Ä–∞–≤–∞
  –û–Ω –∑–Ω–∞–µ—Ç –∫–æ–≥–¥–∞...
  –æ–Ω –ø—Ä—ã–≥–Ω—É–ª?
  –æ–Ω–∏ –≤ –æ–∫–Ω–∞—Ö
  –û–ø –°–º–æ—Ç—Ä–∏ —á–µ –ø–∞–∫–∞–∂—É)
  –æ–ø –°—é—Ä–ø—Ä–∏–∑
  –æ–ø–∞
  –û–ø–µ—Ä–∞—Ü–∏—è –∫—É—Å—Ç—ã
  –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–≤–∞
  –û—Ç–∫—Ä–æ–≤–µ–Ω–∏–µ
  –æ—Ç–∫—É–¥–∞ –æ–Ω –∫–∏–¥–∞–µ—Ç –≥—Ä–∞–Ω–∞—Ç—ã? )
  –û—Ö–æ—Ç–∞ –Ω–∞ –±–µ–ª–∫—É
  –ü–∞–∂–∂–∞–∞–∞–∞–ª—É–π—Å—Ç–∞ UwU
  –ü–∞—Ä–µ–Ω—å —É—Å—Ç–∞–ª
  –ü–ª–∞–Ω –≠–ª—å–¥–∞—Ä–∞
  –ü–æ–¥—Å—Ç–∞–≤–∞
  –ü—Ä–∏–≤–µ—Ç)
  –ø—Ä–∏–≤–µ—Ç–∏–∫))
  –ü—Ä–æ–±–Ω—ã–π —Å—Ç—Ä–∏–º –ø–µ—Ä–µ–¥ –≤–∞–π–ø–æ–º, —è –≤–µ—Ä–Ω—É–ª—Å—è)))
  –ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ —É–±–∏–≤–∞–Ω–∏–µ –¥–µ—Ç–µ–π!
  –ü—Ä–æ—Å—Ç–æ —Å–º–µ—à–Ω–æ —Å–∫–∞–∑–∞–ª–∞))
  –ø—Ä—É—Ñ
  –ø—Ä—É—Ñ—ã —á—Ç–æ —Ä–∞–∑–≤—è–∫–∞ —á—Ç–æ? –¢–û–ü
  –ø—Ä—ã–≥–Ω—É —Å–æ —Å–∫–∞–ª—ã
  –ü—Ä—ã–∂–æ–∫ –í–µ—Ä—ã –ë—Ä–µ–∂–Ω–µ–≤–æ–π
  –ü—Ä—ã–∂–æ–∫ –õ–ï–†–´
  –ü—Ä—ã–∂–æ–∫ —Å–º–µ—Ä—Ç–∏
  –†–∞–¥–∏–∫—É–ª–∏—Ç –Ω–∞–º –Ω–µ —Å—Ç—Ä–∞—à–µ–Ω! (–ø—Ä–∏—Ü–µ–ª –∑–∞–±–∞–≥–∞–ª–æ)
  –†–∞–∑–Ω–∏—Ü—ã –Ω–∏–∫–∞–∫–æ–π
  –†–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ –ö–∞—Ä–∞—Å—è
  —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
  –° –î–†.
  –°–ë–≠–£ –ü–û–ë–ï–î–ò–õ–û!!!
  –°–≤–æ–π –∏–ª–∏ —á—É–∂–æ–π?
  —Å–≤–æ–π —Å—Ä–µ–¥–∏ —á—É–∂–∏—Ö –∞—Ö–∞
  —Å–∫–∞–∂–∏—Ç–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞
  –°–∫–∞–π–ª–∞–π–Ω –¥–∂—Ç—Ä
  –°–∫–∏–ª–ª –Ω–µ –ø—Ä–æ–ø–∏–µ—à—å
  –°–∫—Ä–∏–º–µ—Ä
  —Å–Ω–∞–π–ø–µ—Ä –±–ª—è—Ç—å)))
  —Å–Ω–∞–π–ø–µ—Ä—Å–∫–∞—è –ø–µ—Ä–µ—Å—Ç—Ä–µ–ª–∫–∞
  –°–ø–æ—Ä—Ç—Å–º–µ–Ω –æ–¥–Ω–∞–∫–æ!
  –°—Ç—Ä–∞—Ö –∏ –Ω–µ–Ω–∞–≤–∏—Å—Ç—å –≤ –¢–∞—Ä–∫–æ–≤–µ
  –°—Ç—Ä–∞—à–Ω–æ –∂–µ —Ç–∞–∫ –≤—ã–ø—Ä–∏–≥–∏–≤–∞—Ç—å
  –°—É–¥–æ—Ä–æ–≥–∏
  –°—á–∞—Å—Ç–ª–∏–≤–∞—è!
  —Ç–∞ –º–Ω–µ –ø–∏–∑–¥–∞..... –∞ –Ω–µ—Ç ! –Ω–µ –ø–∏–∑–¥–∞!
  –¢–∞—Ä–∫–æ–≤ –Ω—É —Å–æ–≤—Å–µ–º –Ω–µ —Å—Ç—Ä–∞—à–Ω—ã–π!
  —Ç–∞—Ä–∫–æ–≤—Å–∫–∏–µ –∫—Ä–∏–ø—ã
  –¢–≤–∏–∫—Å –¥–µ–≤—É—à–∫–∞ –ª–µ–∂–µ–±–æ–∫–∏ verified
  —Ç–æ–∂–µ –±–∞–∑–∞
  –¢—Ä–∏–ø–µ—Ä
  –¢—É—Ä–Ω–∏—Ä—á–∏–∫.)
  –¢—É—Ç—É—Ç—É —Ç—É —Ç—É —Ç—É—Ç—É—Ç—É—Ç
  –¢—ã –ø–æ –º–µ—Ç–∞–ª–ª—É —à–ª–µ–ø–∞–µ—à—å?
  –£ –õ–µ—Ä—ã –≥—Ä–µ–Ω—ã —É–º–Ω—ã–µ)
  –£ –Ω–∞—Å –∑–∞–º–µ–Ω–∞
  –£–±–µ–≥–∞–µ—Ç —Å –∫—Ä–∞—Å–Ω—ã–º —Å—Ç–≤–æ–ª–æ–º
  –£–±–∏–≤—Ü–∞!
  –£–±–∏–ª–∞ —Ñ–ª–µ—à–∫–æ–π
  –£–±—Ä–∞–ª–∏ –ª—É—Ç —Å –∫–∞—Ä—Ç. –í–∞–π–ø –±–ª–∏–∑–∫–æ.
  –£–í–£ –ò–í–ê–ù–ê (–°–ò–õ–¨–ù–û)
  –£–¥–∏–≤–ª–µ–Ω–∏–µ
  –£–ª–∞—á
  —É–ª–∏—Ü–∞
  —É–º–µ—Ä –º–æ–ª–æ–¥—ã–º
  —É—Å—Ç–∞–ª –ø—Ä–∏—Å–µ–ª –ø—Ä–∏–ª—ë–≥
  –£—É—É—É –≤–µ–∑–µ–Ω–∏–µ))))
  –§–∏—Ä–∫–æ—Å –Ω–µ –±–ª—è—Ç—å)))
  –•–æ–±–∞
  –•–æ—Ä–æ—à–∞—è
  –•–æ—Ä–æ—à–∞—è –ø–æ–ø—ã—Ç–∫–∞ –î–∂–æ–Ω–∏)
  –•–æ—Ä–æ—à–æ –ø—Ä–∏–Ω—è–ª–∞!
  –•–æ—Ç–µ–ª —É–µ—Ö–∞—Ç—å, –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å
  –ß–∞–≤–æ
  —á–µ–∫–∞–π
  —á–∏—Ç
  –ß–∏—Ç–∞–∫?
  –ß–∏—Ç–µ—Ä–æ–≤ –≤ –∏–≥—Ä–µ –Ω–µ—Ç—É)
  —á—Ç–æ
  –ß—Ç–æ —Å –≥—Ä–µ–Ω–æ–π?
  —á—Ç–æ —Ç—É—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç
  –ß—Ç–æ –ß—Ç–æ –ß—Ç–æ????!!!
  –ß—Ç–æ-—Ç–æ —É–∑–Ω–∞—Ç—å —Ö–æ—Ç–µ–ª
  –ß—É–¥–æ!
  –ß—É–ø–∞ –±–µ–∑ –ú–∫–∏ —Ç–µ–ø–µ—Ä—å
  —à–æ
  —à—Ç–æ?
  –´—ã—ã—ã, –ø–æ—Ä–∂–∞–ª
  –≠–π –ø–∞—Ä–µ–Ω—å –∏–¥–∏ —Å—é–¥–∞)))
  —ç—Ç–æ –Ω–µ —Ä–∞–∑–º–µ–Ω)))
  —ç—Ç–æ —Ç–∏–ª—å—Ç
  –≠—Ç–æ —Ç—ã? –¢–æ—Ä–º–æ–∑–∏!
  –≠—Ç–æ —è
  –≠—ç—ç—Ç–æ –±—ã–ª —Ç—ã....
  –Ø –≤–æ–æ–±—â–µ-—Ç–æ..
  –Ø –∫–æ–≥–æ —Ç–æ —É–±–∏–ª–∞?!
  —è –Ω–µ —Ñ–ª—É–¥–∏–ª
  —è –Ω–µ–π—Ä–æ—Å–µ—Ç—å
  –Ø —Å –°–∞—Ö–∞–ª–∏–Ω–∞
  —è —Ç–≤–æ–π –º–∞–Ω—Å—É–ª—å
  –Å–ª–æ—á–∫–∏
  ‚Ññ"!"@#!
HEREDOC

fail unless "–ê–ª–ª–æ, –ë—É—è–Ω–æ–≤?" == smart_match("–±—É—è–Ω–æ–≤", clips, &:itself)
fail unless "—ç—Ç–æ —Ç–∏–ª—å—Ç" == smart_match("—Ç–∏–ª—å—Ç", clips, &:itself)
fail unless "–ú–ê–®–ò–ù–ê –õ–ï–†–ê" == smart_match("–ª–µ—Ä–∞ –º–∞—à–∏–Ω–∞", clips, &:itself)
  end

  it "#get_item_name #parse_response" do
fail unless "–°—Ç–∞—Ç—É—ç—Ç–∫–∞ –∫–æ—Ç–∞" == p(Common.method(:get_item_name).("–∫–æ—Ç"))
fail unless "–ë—É—Ç—ã–ª–∫–∞ –ø–∏–≤–∞ \"–ü–µ–≤–∫–æ —Å–≤–µ—Ç–ª–æ–µ\"" == p(Common.method(:get_item_name).("–ø–∏–≤–∫–æ"))
fail unless "–ù–∞–±–æ—Ä –º–µ–¥–∏–∫–∞–º–µ–Ω—Ç–æ–≤" == p(Common.method(:get_item_name).("–º–µ–¥."))
fail unless "12/70 —Ñ–ª–µ—à–µ—Ç—Ç–∞" == p(Common.method(:get_item_name).("—Ñ–ª–µ—à–µ—Ç—Ç—ã"))  # TwixFix
fail unless "–ö—É–¥–∞ –ø—Ä–æ–¥–∞—Ç—å %s: –±–∞—Ä–∞—Ö–æ–ª–∫–∞ - 29900 ‚ÇΩ, –¢–µ—Ä–∞–ø–µ–≤—Ç - 8343 ‚ÇΩ" == p(Common.method(:parse_response).(File.read "pevko.htm"))  # +–±–∞—Ä–∞—Ö–æ–ª–∫–∞ -$
fail unless "–ö—É–¥–∞ –ø—Ä–æ–¥–∞—Ç—å %s: –ë–∞—Ä–∞—Ö–æ–ª—å—â–∏–∫ - 232190 ‚ÇΩ, –ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü - 1416 $" == p(Common.method(:parse_response).(File.read "slick.htm"))  # -–±–∞—Ä–∞—Ö–æ–ª–∫–∞ +$spaces
    assert_equal "–ö—É–¥–∞ –ø—Ä–æ–¥–∞—Ç—å %s: –¢–µ—Ä–∞–ø–µ–≤—Ç - 39254 ‚ÇΩ, –ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü - 203 $", p(Common.method(:parse_response).(File.read "cat.htm"))
  end

end

describe "integration1" do

  it do
    assert_match /\A–ö—É–¥–∞ –ø—Ä–æ–¥–∞—Ç—å \"–°—Ç–∞—Ç—É—ç—Ç–∫–∞ –∫–æ—Ç–∞\": –¢–µ—Ä–∞–ø–µ–≤—Ç - \d+ ‚ÇΩ, –ú–∏—Ä–æ—Ç–≤–æ—Ä–µ—Ü - \d+ \$\z/, p(Common.price("–∫–æ—Ç"))
fail unless "\"–ó–∞—â–∏—â–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä \\\"–ö–∞–ø–ø–∞\\\"\" –Ω–µ –ø—Ä–æ–¥–∞—Ç—å" == p(Common.price("–∫–∞–ø–ø–∞"))
fail unless "can't find \"–ë—É—Ç—ã–ª–∫–∞ –≤–æ–¥–∫–∏ \\\"–¢–∞—Ä–∫–æ–≤—Å–∫–∞—è\\\"\"" == p(Common.price("—Ç–∞—Ä–∫–æ–≤—Å–∫–∞—è"))  # the website is stupid about quotes
  end

end

require "nakiircbot"
describe "unit2" do

  it "track" do
    negative = <<~HEREDOC.split(?\n).each do |line|
      —á—Ç–æ –∑–∞ —Ç—Ä–µ–∫ –±—ã–ª?
      –û–≥–æ —á—Ç–æ –∑–∞ —Ç—Ä—ç–∫ –≤ 2023)
      –°–∫–∏–Ω—å —Ç—Ä–µ–∫ –ø—Ä–µ–¥—ã–¥—É—â–∏–π
      –ø–æ—Ç–æ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –≥—É–≥–ª–∞ —Ç–∫–Ω—É–ª –≤ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ, —á—Ç–æ–± —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –æ–Ω–æ –≤–∏–¥–∏—Ç, —á—Ç–æ –∑–∞ —Ç—Ä–µ–∫
      –ù—É —á—Ç–æ –∑–∞ –ø–µ—Å–Ω—è –†—ç–Ω... 10 —á–∞—Å–æ–≤ –ø–æ–¥—Ä—è–¥ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞
      –ß—Ç–æ –∑–∞ –ø–µ—Å–Ω—è –ø—Ä–∏ —Ä–µ–π–¥–µ –∑–≤—É—á–∏—Ç?
      –õ–µ—Ä, —á—Ç–æ –∑–∞ –ø–µ—Å–Ω—è –±—ã–ª–∞?
    HEREDOC
      refute Common.is_asking_track(line), line
    end
    positive = <<~HEREDOC.split(?\n).each do |line|
      @VELLREIN –ö–∏–Ω—å –ø–ª–∑ –≤ —á–∞—Ç —Å—Å—ã–ª–∫—É –Ω–∞ —Ç—Ä—ç–∫
      @VELLREIN –∞ —á—Ç–æ —ç—Ç–æ –∑–∞ —á—É–¥–µ—Å–Ω–∞—è –º—É–∑—ã–∫–∞ –∏–≥—Ä–∞–µ—Ç?
      @ta_samaya_lera –ø—Ä–∏–≤–µ—Ç —á–µ –∑–∞ —Ç—Ä–µ–∫ ? –∫–∞—á–∞–µ—Ç)
      –†–µ–Ω—è —Å–∫–∏–Ω—å –ø–æ–∂–∞–ª—É–π—Å—Ç–∞ —ç—Ç–æ—Ç —Ç—Ä–µ–∫ –∫–æ—Ç–æ—Ä—ã–π –∏–≥—Ä–∞–ª
      –ú—É–∑—ã–∫–∞ –∑–∞—Å—Ç–∞–≤–ª—è–µ—Ç –≤—Å–ª—É—à–∏–≤–∞—Ç—å—Å—è –≤ —Å–ª–æ–≤–∞)) —á—Ç–æ –∑–∞ —Ç—Ä–µ–∫))
      –û–æ–æ –º—É–∑—ã–∫–∞ —Ç–æ–ø –º–æ–∂–Ω–æ —Ç—Ä–µ–∫ ?)
      –∫–∞—Ç—è —á—Ç–æ –∑–∞ —Ç—Ä–µ–∫, –≥–æ–ª–æ—Å —É –¥–µ–≤–∫–∏ –ø—Ä–∏—è—Ç–Ω—ã–π
      –∫–∞–∫ —Ç—Ä–µ–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è ,—Å—Ä–æ—á–Ω–æ –¥–∞–π—Ç–µ –¥–∞–π—Ç–µ!
      —Ç—ë—Ç—å –õ–µ—Ä, –∞ —á—Ç–æ –∑–∞ —Ç—Ä–µ–∫ –∏–≥—Ä–∞–µ—Ç? Kappa
      –ê –º–æ–∂–Ω–æ —Ç—Ä–µ–∫? –ß—Ç–æ –≤ –¥–æ–Ω–∞—Ç–µ
      –î–∞–π—Ç–µ —Ç—Ä–µ–∫ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞
      –ê –º–æ–∂–Ω–æ —Ç—Ä–µ–∫ –º–Ω–µ –ø–æ–∂–∞–ª—É–π—Å—Ç–∞?
      –∞ –º–æ–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞?))
      –∞ –º–æ–∂–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç—Ä–µ–∫–∞?)
      –º–æ–∂–Ω–æ —Ç—Ä—ç–∫ –ø–æ–∂–∞–ª–π—Å—Ç–∞?
      –ú–æ–∂–Ω–æ —Ç—Ä–µ–∫?
      –º–æ–∂–Ω–æ —Ç—Ä–µ–∫
      –û–≥–æ, –∞ –º–æ–∂–Ω–æ —Ç—Ä–µ–∫ ?
      –∫–∞–∫ —Ç—Ä–µ–∫ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è?
      –æ–π –∞ —á–æ —ç—Ç–æ –∑–∞ –º—É–∑—ã–∫–∞...
      —á–æ –∑–∞ –º—É–∑—ã–∫–∞
      —á—Ç–æ –∑–∞ –º—É–∑—ã–∫–∞?
      –ß—Ç–æ –∑–∞ –º—É–∑—ã–∫–∞?
      –ß—Ç–æ —ç—Ç–æ –∑–∞ –º—É–∑—ã–∫–∞ NotLikeThis
      –ß—Ç–æ –∑–∞ —Ç—Ä–µ–∫ —Å–µ–π—á–∞—Å –∏–≥—Ä–∞–µ—Ç?
      —á—Ç–æ –∑–∞ —Ç—Ä–µ–∫? —Å–∫–∏–Ω—å –Ω–∞–∑–≤–∞–Ω–∏–µ
      –±–ª–∏–Ω —á–æ –∑–∞ —Ç—Ä–µ–∫
      –ê —á—Ç–æ –∑–∞ —Ç—Ä–µ–∫?
      –∞ —á—ë –∑–∞ —Ç—Ä–µ–∫?
      –ß—Ç–æ –∑–∞ —Ç—Ä–µ–∫ ?
      –ß—Ç–æ –∑–∞ —Ç—Ä–µ–∫?
      —á—Ç–æ –∑–∞ —Ç—Ä–µ–∫?
      —á—Ç–æ –∑–∞ —Ç—Ä–µ–∫
      —á—ë –∑–∞ —Ç—Ä–µ–∫?
      —á–æ –∑–∞ —Ç—Ä–µ–∫
      —á–µ –∑–∞ —Ç—Ä–µ–∫?)
      —É—Ö —á–æ –∑–∞—Ç—Ä—ç–∫
      –°–∫–∏–Ω—å —Ç—Ä—ç–∫)
      –°–∫–∏–Ω—å —Ç—Ä–µ–∫ )
      —á—Ç–æ –∑–∞ –ø–µ—Å–Ω—è?
      –ß—Ç–æ –∑–∞ –ø–µ—Å–Ω—è ?
      –∞ —á—Ç–æ –∑–∞ –ø–µ—Å–Ω—è
      –ß—Ç–æ —ç—Ç–æ –∑–∞ –ø–µ—Å–Ω—è
      —á—ë –∑–∞ –ø–µ—Å–Ω—è –∏–≥—Ä–∞–µ—Ç?
      —á–µ –∑–∞ –ø–µ—Å–Ω—è –º–æ–ª–æ–¥–æ—Å—Ç–∏
      –ö—Ç–æ—Ç–æ —Å–∫–∞–∂–µ—Ç —á—ë –∑–∞ –ø–µ—Å–Ω—è ?
      –ê —è –¥–∞–∂–µ –Ω–µ –≤–∫—É—Ä—Å–µ —á—Ç–æ –∑–∞ –ø–µ—Å–Ω—è
      –í—ã–ø–∏–π —Å—É–ø –ø–∞—ë–∫/? –ß—Ç–æ –∑–∞ –ø–µ—Å–Ω—è —Ç–∞–∫–∞—è
    HEREDOC
      assert Common.is_asking_track(line), line
    end
    Dir.glob("vps_logs/txt.*").sort.each do |path|
      puts path
      filename = "#{File.basename path}.marshal"
      ( if File.exist? filename
        Marshal.load File.binread filename
      else
        NakiIRCBot.parse_log(path, "velik_bot").tap do |_|
          File.binwrite filename, Marshal.dump(_)
        end
      end.map do |line|
        line[4] if "PRIVMSG" == line[2]
      end.compact - positive ).each do |line|
        refute Common.is_asking_track(line), line
      end
    end
  end

  it "rep" do
    Common.instance_variable_get(:@repdb).transaction{ |db| db.roots.each &db.method(:delete) }
    Common.rep_plus "#channel", "user1", "user1"
    Common.rep_plus "#channel", "user1", "user2"
    Common.rep_minus "#channel", "user1", "user2"
    Time.stub(:now, Time.now + 90000){ Common.rep_plus "#channel", "user1", "user2" }
    assert_equal "@user1's current rep is 0 (top-2)", Common.rep_read_precise("#channel", "user1")
    assert_equal "@user2's current rep is 2 (top-1)", Common.rep_read("#channel", "user2")
    Common.rep_minus "#channel", "channel", "user2"
    Common.rep_minus "#channel", "channel", "user2"
    assert_equal "@user2's current rep is 0 (top-1)", Common.rep_read("#channel", "ser2")
  end

  # str, add_to_queue, restart_with_new_password, who, where, what
  it "loop" do
    e = []
    prev = Thread.list.size
    NakiIRCBot.define_singleton_method :start do |*, &b|
      t = []; b.call nil, ->__,_{t<<_}, nil, nil,             nil, "\\?"       ; e.push [t.dup, "\\? who=nil", []]
      t = []; b.call nil, ->__,_{t<<_}, nil,  "",              "", "\\?"       ; e.push [t.dup, "\\?", ["–¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã: lastclip, clip, clip_from, ?rep, +rep, -rep, price, song, goons -- –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ \\help <–∫–æ–º–∞–Ω–¥–∞> –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø—Ä–∞–≤–∫–∏ –ø–æ –∫–∞–∂–¥–æ–π"]]
      t = []; b.call nil, ->__,_{t<<_}, nil,  "",              "", "\\song"    ; e.push [t.dup, "\\song -–∏–Ω—Ç–µ–≥—Ä -–≤–µ—Ä—Ö -—Ä—É—Å—Å +song", ["no integration with "]]
      t = []; b.call nil, ->__,_{t<<_}, nil,  "", "#nekochan_myp", "—á–æ –∑–∞ —Ç—Ä–µ–∫"; e.push [t.dup, "\\song -–∏–Ω—Ç–µ–≥—Ä +–≤–µ—Ä—Ö +—Ä—É—Å—Å -song", [/–æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è/]]
      t = []; b.call nil, ->__,_{t<<_}, nil,  "", "#nekochan_myp", "."         ; e.push [t.dup, "\\song -–∏–Ω—Ç–µ–≥—Ä +–≤–µ—Ä—Ö -—Ä—É—Å—Å -song", []]
      t = []; b.call nil, ->__,_{t<<_}, nil,  "", "#korolikarasi", "."         ; e.push [t.dup, "\\song +–∏–Ω—Ç–µ–≥—Ä -–≤–µ—Ä—Ö -—Ä—É—Å—Å -song", []]
      t = []; b.call nil, ->__,_{t<<_}, nil,  "", "#korolikarasi", "—á–æ –∑–∞ —Ç—Ä–µ–∫"; Timeout.timeout(2){ sleep 0.1 until prev + 1 == Thread.list.size }; e.push [t.dup, "\\song +–∏–Ω—Ç–µ–≥—Ä -–≤–µ—Ä—Ö +—Ä—É—Å—Å -song", [/üé∂/]]   # +1 is a Timeout thread itself
      t = []; b.call nil, ->  *_{t<<_}, nil, "name", "#channel", "_ _–∫–∞—Ä–∞—Å_ _" ; e.push [t.dup, "–∫–∞—Ä–∞—Å—å", [["#korolikarasi", "#channel <name> _ _–∫–∞—Ä–∞—Å_ _"]]]
    end
    require_relative "main"
    e.each{ |r, t, e| [e, r].transpose.each{ |e, r| assert_operator e, :===, r, "(test: #{t.inspect})" } }
  end

end

describe "integration2" do
  it "clip" do
    assert_equal "https://clips.twitch.tv/RichProtectiveOcelotNotATK-6MH7oHRTHSk1lzuh", Common.clip("korolikarasi", "—á–µ–ª–æ–≤–µ–∫–¥–µ—Ä–µ–≤–æ")
  end
end
